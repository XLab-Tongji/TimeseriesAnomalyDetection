# A Novel Technique for Long-Term Anomaly Detection in the Cloud

[toc]

## 原文阅读

文章标题：**A Novel Technique for Long-Term Anomaly Detection in the Cloud**（2014，引用：153）

* **内容介绍**：前两周我们大概了解了通过神经网络做异常检测的一些方法，这周我选择阅读的论文更多地从传统机器学习算法的角度，通过一些统计学和数学的方法检测异常值。

* **引言**：云计算随着发展在现代社会中占据着越来越重要的地位，文章的作者是twitter的一名工程师，他提到twitter当下面临的一个问题是如何自动检测云平台上的长期异常，即**long-term anomalies**。

  * 注：长期过程中的异常之所以难以检测，是因为时间序列有潜在的占主导性的趋势(trend)，若不考虑trend采用短期异常检测的做法，误报的可能性很大，因为没有考虑到数据本身的趋势。

  为此作者在ESD(generalized Extreme Studentized Deviate)的基础上建立了一种新的统计学方法，称之为分段中值法(**picewise median**)，并在实际生产数据上测试了其性能。

  * ESD：检测单变量异常值的一种统计学方法，数学表达式如下：

    ![v2-f04fa2d537a3fb26bf6772c5017d41da_720w](img\cfjy\v2-f04fa2d537a3fb26bf6772c5017d41da_720w.png)

  ![v2-105435500796759b70e05ae2b6310c74_720w](img\cfjy\v2-105435500796759b70e05ae2b6310c74_720w.png)

  s为标准差，N为数据数，t为t-student分布

  先计算出数据集的G值，然后将G与第二个公式中的右值做比较，当G大时，认为数据集中至少有1个异常值。

  * 注：作者采用的ESD检测里，均值(mean)用中值(median)替代,标准差(standard deviation)用中值绝对偏差(median absolute deviation)替代。

    ![屏幕截图 2020-10-26 013421](D:\tools\screencut\屏幕截图 2020-10-26 013421.png)

* **公式基础**：
  $$
  时间序列X是x_t的集合，其中t=0,1,2...
  $$

  $$
  R_X=X-S_X-T_X
  $$

  * 解释：X可分解为三部分

    ​           Sx是周期性成分，描述序列的周期性变化

    ​           Tx是趋势成分，描述序列的总体趋势（非周期性）

    ​           Rx是X去掉Sx和Tx后的剩余成分

    **异常检测主要针对Rx进行检测**

* **新技术：分段中值法**

  周期性成分比较容易确定，趋势成分(trend)如何提取将直接影响结果的好坏，所以如何确定trend十分关键。

  经过实际实验发现，以中值代替得到的trend从X中减去，这种方法的性能好于直接减去Tx，能减少误报的产生，如下图：

  ![屏幕截图 2020-10-26 014909](img\cfjy\屏幕截图 2020-10-26 014909.png)

  但是这种方法只对trend比较平的序列比较有效，在有显著trend的长期序列中表现很差。

  作者考察了现有的两种提取trend的方法：STL trend和分位数回归法(quantile regression)，然后提出了新技术——分段中值法，并比较了它们的性能。

  * STL trend大致步骤：

    * 从序列中减去估计的trend，将得到的新序列划分为子周期序列(sub-cycle series)
    * 对每个子周期序列运用LOESS(局部加权回归)，估计Sx，从原始序列中减去Sx得到新的序列，对新序列运用LOESS得到新的trend估计值
    * 重复上述步骤直到新的trend估计值不再改变或改变得很小

    注：局部加权回归LOESS

    ![20170218112204260](img\cfjy\20170218112204260.png)

    局部加权回归：以一个点x为中心，向前后截取一段长度为frac的数据，对于该段数据用权值函数w做一个加权的线性回归。对于所有的n个数据点则可以做出n条加权回归线，每条回归线的中心值的连线则为这段数据的Lowess曲线。

  * 分位数回归法(quantile regression)：

    ![20190709222211556](img\cfjy\20190709222211556.jpeg)

    分位数回归是把分位数的概念融入到普通的回归里，所谓的0.9分位数回归，就是希望回归曲线之下能够包含90%的数据点，这也是分位数的概念。

    * 用B-Spline曲线做分位数回归已被证实是很有效的提取trend的方法，但是这种方法适用于两周以上的长序列，当时间小于两周时会过拟合，这就意味着假如出现大块的异常数据隔断了正常数据，这种方法的性能会受到严重影响。

  * 分段中值法(piecewise median):

    分段中值法的思想是用分段取中值的方法对序列的trend做近似，算法如下图

    ![屏幕截图 2020-10-26 024517](img\cfjy\屏幕截图 2020-10-26 024517.png)

    * 窗口大小的选取要注意，一般包括两个完整周期，至少要有一个周期
    * 0.49是多次实验得到的序列能容纳的最大异常率

  三种方法提取trend的示意图如下![屏幕截图 2020-10-26 025256](img\cfjy\屏幕截图 2020-10-26 025256.png)

* **性能比较**：

  * 有效性：三种方法在实际生产数据上的测试结果如下图

    ![屏幕截图 2020-10-26 025902](img\cfjy\屏幕截图 2020-10-26 025902.png)

    可以看出三种方法都能检测出比较明显的异常，但相比于piece median，另外两种方法的误报更多。STL是将很多正常数据检测为了异常数据，quantile b-spline是没有检测出很多本该是异常的数据。

  * 实时性能：三种方法在实际生产数据上的实时性能测试结果如下表

    ![屏幕截图 2020-10-26 030459](img\cfjy\屏幕截图 2020-10-26 030459.png)

    当分析三个月的以分(minute)为单位的序列数据时，piecewise median只用了四分多钟，随着数据量的增大，提升的效果是显著的。

  * 注入分析：实际中很难得到异常数据，可以采用异常注入的方法进行测试

    * 异常注入在两个维度上进行：注入时间和异常量级

    * 三种方法异常注入实验结果如下图

      ![屏幕截图 2020-10-26 031650](img\cfjy\屏幕截图 2020-10-26 031650.png)

## 问题和思考

* ESD的检测手段没太明白，它是不是能检测出单独的异常数据？为什么？
* 采用统计学习的方法做异常检测，样本是怎么个取法？比如说在固定样本的数据上用piecewise median检测出了一些异常数据，因为数据是实时增加的，增加后又该怎么检测？是只需要检测增加的这一部分呢，还是要从增加的部分算起，前面的部分都要算进去进行检测？换句话说，实时检测是怎么个实时法？
* 统计方法的性能会比神经网络更好吗？除了和神经网络相互验证之外，为什么还要研究传统的统计方法？

